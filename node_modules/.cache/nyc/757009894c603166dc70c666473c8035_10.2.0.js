var cov_212ik2zhz0=function(){var path='/Users/thomas/Desktop/sim-stock/users/router.js',hash='677de99afad0bf7bedf883b1fe4fd7a4e5519d93',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/thomas/Desktop/sim-stock/users/router.js',statementMap:{'0':{start:{line:1,column:24},end:{line:1,column:48}},'1':{start:{line:2,column:16},end:{line:2,column:34}},'2':{start:{line:3,column:17},end:{line:3,column:36}},'3':{start:{line:4,column:15},end:{line:4,column:32}},'4':{start:{line:5,column:15},end:{line:5,column:31}},'5':{start:{line:6,column:19},end:{line:6,column:48}},'6':{start:{line:7,column:17},end:{line:7,column:36}},'7':{start:{line:8,column:11},end:{line:8,column:24}},'8':{start:{line:9,column:15},end:{line:9,column:32}},'9':{start:{line:10,column:16},end:{line:10,column:34}},'10':{start:{line:12,column:0},end:{line:12,column:23}},'11':{start:{line:13,column:0},end:{line:13,column:34}},'12':{start:{line:15,column:23},end:{line:15,column:66}},'13':{start:{line:16,column:23},end:{line:16,column:63}},'14':{start:{line:19,column:0},end:{line:36,column:3}},'15':{start:{line:25,column:2},end:{line:34,column:6}},'16':{start:{line:33,column:4},end:{line:33,column:28}},'17':{start:{line:39,column:0},end:{line:40,column:65}},'18':{start:{line:43,column:0},end:{line:48,column:5}},'19':{start:{line:47,column:4},end:{line:47,column:66}},'20':{start:{line:51,column:0},end:{line:59,column:3}},'21':{start:{line:53,column:4},end:{line:57,column:7}},'22':{start:{line:54,column:6},end:{line:54,column:36}},'23':{start:{line:54,column:17},end:{line:54,column:34}},'24':{start:{line:55,column:6},end:{line:55,column:46}},'25':{start:{line:55,column:19},end:{line:55,column:44}},'26':{start:{line:56,column:6},end:{line:56,column:48}},'27':{start:{line:64,column:0},end:{line:69,column:2}},'28':{start:{line:67,column:3},end:{line:67,column:40}},'29':{start:{line:75,column:0},end:{line:82,column:3}},'30':{start:{line:76,column:1},end:{line:81,column:5}},'31':{start:{line:80,column:3},end:{line:80,column:30}},'32':{start:{line:88,column:0},end:{line:119,column:2}},'33':{start:{line:89,column:1},end:{line:117,column:4}},'34':{start:{line:97,column:3},end:{line:113,column:6}},'35':{start:{line:109,column:5},end:{line:109,column:32}},'36':{start:{line:112,column:5},end:{line:112,column:22}},'37':{start:{line:116,column:3},end:{line:116,column:20}},'38':{start:{line:125,column:0},end:{line:172,column:3}},'39':{start:{line:126,column:1},end:{line:128,column:2}},'40':{start:{line:127,column:2},end:{line:127,column:62}},'41':{start:{line:130,column:1},end:{line:171,column:4}},'42':{start:{line:134,column:16},end:{line:134,column:45}},'43':{start:{line:137,column:3},end:{line:143,column:4}},'44':{start:{line:138,column:4},end:{line:142,column:5}},'45':{start:{line:139,column:5},end:{line:139,column:31}},'46':{start:{line:140,column:5},end:{line:140,column:75}},'47':{start:{line:141,column:5},end:{line:141,column:75}},'48':{start:{line:145,column:3},end:{line:149,column:6}},'49':{start:{line:146,column:4},end:{line:148,column:5}},'50':{start:{line:147,column:5},end:{line:147,column:21}},'51':{start:{line:151,column:3},end:{line:166,column:7}},'52':{start:{line:155,column:5},end:{line:155,column:41}},'53':{start:{line:157,column:5},end:{line:161,column:8}},'54':{start:{line:158,column:6},end:{line:160,column:7}},'55':{start:{line:159,column:7},end:{line:159,column:23}},'56':{start:{line:162,column:5},end:{line:162,column:33}},'57':{start:{line:165,column:5},end:{line:165,column:47}},'58':{start:{line:169,column:2},end:{line:169,column:19}},'59':{start:{line:170,column:2},end:{line:170,column:40}},'60':{start:{line:178,column:0},end:{line:216,column:3}},'61':{start:{line:179,column:1},end:{line:181,column:2}},'62':{start:{line:180,column:3},end:{line:180,column:63}},'63':{start:{line:183,column:1},end:{line:215,column:4}},'64':{start:{line:187,column:16},end:{line:187,column:45}},'65':{start:{line:189,column:3},end:{line:193,column:4}},'66':{start:{line:190,column:4},end:{line:192,column:5}},'67':{start:{line:191,column:5},end:{line:191,column:75}},'68':{start:{line:195,column:3},end:{line:210,column:7}},'69':{start:{line:199,column:5},end:{line:199,column:41}},'70':{start:{line:201,column:5},end:{line:205,column:8}},'71':{start:{line:202,column:6},end:{line:204,column:7}},'72':{start:{line:203,column:7},end:{line:203,column:23}},'73':{start:{line:206,column:5},end:{line:206,column:33}},'74':{start:{line:209,column:5},end:{line:209,column:53}},'75':{start:{line:213,column:2},end:{line:213,column:19}},'76':{start:{line:214,column:2},end:{line:214,column:40}},'77':{start:{line:219,column:0},end:{line:219,column:26}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:24,column:2},end:{line:24,column:3}},loc:{start:{line:24,column:53},end:{line:35,column:3}},line:24},'1':{name:'(anonymous_1)',decl:{start:{line:32,column:6},end:{line:32,column:7}},loc:{start:{line:32,column:21},end:{line:34,column:4}},line:32},'2':{name:'(anonymous_2)',decl:{start:{line:45,column:2},end:{line:45,column:3}},loc:{start:{line:45,column:21},end:{line:48,column:3}},line:45},'3':{name:'(anonymous_3)',decl:{start:{line:52,column:2},end:{line:52,column:3}},loc:{start:{line:52,column:24},end:{line:58,column:3}},line:52},'4':{name:'(anonymous_4)',decl:{start:{line:53,column:38},end:{line:53,column:39}},loc:{start:{line:53,column:59},end:{line:57,column:5}},line:53},'5':{name:'(anonymous_5)',decl:{start:{line:66,column:2},end:{line:66,column:3}},loc:{start:{line:66,column:22},end:{line:68,column:3}},line:66},'6':{name:'(anonymous_6)',decl:{start:{line:75,column:82},end:{line:75,column:83}},loc:{start:{line:75,column:96},end:{line:82,column:1}},line:75},'7':{name:'(anonymous_7)',decl:{start:{line:79,column:8},end:{line:79,column:9}},loc:{start:{line:79,column:28},end:{line:81,column:3}},line:79},'8':{name:'(anonymous_8)',decl:{start:{line:88,column:83},end:{line:88,column:84}},loc:{start:{line:88,column:97},end:{line:118,column:2}},line:88},'9':{name:'(anonymous_9)',decl:{start:{line:96,column:8},end:{line:96,column:9}},loc:{start:{line:96,column:17},end:{line:114,column:3}},line:96},'10':{name:'(anonymous_10)',decl:{start:{line:108,column:10},end:{line:108,column:11}},loc:{start:{line:108,column:18},end:{line:110,column:5}},line:108},'11':{name:'(anonymous_11)',decl:{start:{line:111,column:11},end:{line:111,column:12}},loc:{start:{line:111,column:18},end:{line:113,column:5}},line:111},'12':{name:'(anonymous_12)',decl:{start:{line:115,column:9},end:{line:115,column:10}},loc:{start:{line:115,column:16},end:{line:117,column:3}},line:115},'13':{name:'(anonymous_13)',decl:{start:{line:125,column:90},end:{line:125,column:91}},loc:{start:{line:125,column:104},end:{line:172,column:1}},line:125},'14':{name:'(anonymous_14)',decl:{start:{line:133,column:8},end:{line:133,column:9}},loc:{start:{line:133,column:23},end:{line:167,column:2}},line:133},'15':{name:'(anonymous_15)',decl:{start:{line:145,column:13},end:{line:145,column:14}},loc:{start:{line:145,column:22},end:{line:149,column:4}},line:145},'16':{name:'(anonymous_16)',decl:{start:{line:154,column:10},end:{line:154,column:11}},loc:{start:{line:154,column:19},end:{line:163,column:5}},line:154},'17':{name:'(anonymous_17)',decl:{start:{line:157,column:16},end:{line:157,column:17}},loc:{start:{line:157,column:25},end:{line:161,column:6}},line:157},'18':{name:'(anonymous_18)',decl:{start:{line:164,column:11},end:{line:164,column:12}},loc:{start:{line:164,column:18},end:{line:166,column:5}},line:164},'19':{name:'(anonymous_19)',decl:{start:{line:168,column:8},end:{line:168,column:9}},loc:{start:{line:168,column:15},end:{line:171,column:2}},line:168},'20':{name:'(anonymous_20)',decl:{start:{line:178,column:97},end:{line:178,column:98}},loc:{start:{line:178,column:111},end:{line:216,column:1}},line:178},'21':{name:'(anonymous_21)',decl:{start:{line:186,column:8},end:{line:186,column:9}},loc:{start:{line:186,column:23},end:{line:211,column:2}},line:186},'22':{name:'(anonymous_22)',decl:{start:{line:198,column:10},end:{line:198,column:11}},loc:{start:{line:198,column:19},end:{line:207,column:5}},line:198},'23':{name:'(anonymous_23)',decl:{start:{line:201,column:16},end:{line:201,column:17}},loc:{start:{line:201,column:25},end:{line:205,column:6}},line:201},'24':{name:'(anonymous_24)',decl:{start:{line:208,column:11},end:{line:208,column:12}},loc:{start:{line:208,column:18},end:{line:210,column:5}},line:208},'25':{name:'(anonymous_25)',decl:{start:{line:212,column:8},end:{line:212,column:9}},loc:{start:{line:212,column:15},end:{line:215,column:2}},line:212}},branchMap:{'0':{loc:{start:{line:54,column:6},end:{line:54,column:36}},type:'if',locations:[{start:{line:54,column:6},end:{line:54,column:36}},{start:{line:54,column:6},end:{line:54,column:36}}],line:54},'1':{loc:{start:{line:55,column:6},end:{line:55,column:46}},type:'if',locations:[{start:{line:55,column:6},end:{line:55,column:46}},{start:{line:55,column:6},end:{line:55,column:46}}],line:55},'2':{loc:{start:{line:126,column:1},end:{line:128,column:2}},type:'if',locations:[{start:{line:126,column:1},end:{line:128,column:2}},{start:{line:126,column:1},end:{line:128,column:2}}],line:126},'3':{loc:{start:{line:138,column:4},end:{line:142,column:5}},type:'if',locations:[{start:{line:138,column:4},end:{line:142,column:5}},{start:{line:138,column:4},end:{line:142,column:5}}],line:138},'4':{loc:{start:{line:146,column:4},end:{line:148,column:5}},type:'if',locations:[{start:{line:146,column:4},end:{line:148,column:5}},{start:{line:146,column:4},end:{line:148,column:5}}],line:146},'5':{loc:{start:{line:158,column:6},end:{line:160,column:7}},type:'if',locations:[{start:{line:158,column:6},end:{line:160,column:7}},{start:{line:158,column:6},end:{line:160,column:7}}],line:158},'6':{loc:{start:{line:179,column:1},end:{line:181,column:2}},type:'if',locations:[{start:{line:179,column:1},end:{line:181,column:2}},{start:{line:179,column:1},end:{line:181,column:2}}],line:179},'7':{loc:{start:{line:179,column:5},end:{line:179,column:81}},type:'binary-expr',locations:[{start:{line:179,column:5},end:{line:179,column:40}},{start:{line:179,column:44},end:{line:179,column:81}}],line:179},'8':{loc:{start:{line:190,column:4},end:{line:192,column:5}},type:'if',locations:[{start:{line:190,column:4},end:{line:192,column:5}},{start:{line:190,column:4},end:{line:192,column:5}}],line:190},'9':{loc:{start:{line:202,column:6},end:{line:204,column:7}},type:'if',locations:[{start:{line:202,column:6},end:{line:204,column:7}},{start:{line:202,column:6},end:{line:204,column:7}}],line:202}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0,'58':0,'59':0,'60':0,'61':0,'62':0,'63':0,'64':0,'65':0,'66':0,'67':0,'68':0,'69':0,'70':0,'71':0,'72':0,'73':0,'74':0,'75':0,'76':0,'77':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0],'9':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();const{BasicStrategy}=(++cov_212ik2zhz0.s[0],require('passport-http'));const express=(++cov_212ik2zhz0.s[1],require('express'));const mongoose=(++cov_212ik2zhz0.s[2],require('mongoose'));const morgan=(++cov_212ik2zhz0.s[3],require('morgan'));const router=(++cov_212ik2zhz0.s[4],express.Router());const jsonParser=(++cov_212ik2zhz0.s[5],require('body-parser').json());const passport=(++cov_212ik2zhz0.s[6],require('passport'));const fs=(++cov_212ik2zhz0.s[7],require('fs'));const{User}=(++cov_212ik2zhz0.s[8],require('./user'));const{Stock}=(++cov_212ik2zhz0.s[9],require('./stock'));++cov_212ik2zhz0.s[10];router.use(jsonParser);++cov_212ik2zhz0.s[11];router.use(passport.initialize());const GoogleStrategy=(++cov_212ik2zhz0.s[12],require('passport-google-oauth20').Strategy);const BearerStrategy=(++cov_212ik2zhz0.s[13],require('passport-http-bearer').Strategy);++cov_212ik2zhz0.s[14];passport.use(new GoogleStrategy({clientID:'603515610903-ov1hu4kjoghb028raqlmb2ndd4761re1.apps.googleusercontent.com',clientSecret:"K5NBv_fDAp6YcyZJQfNofxVb",callbackURL:"http://localhost:8080/users/auth/google/callback"},function(accessToken,refreshToken,profile,done){++cov_212ik2zhz0.f[0];++cov_212ik2zhz0.s[15];return User.findOrCreate({username:profile.id},{password:accessToken,nickname:profile.displayName},(err,user)=>{++cov_212ik2zhz0.f[1];++cov_212ik2zhz0.s[16];return done(null,user);});}));// Go to login page from Google
++cov_212ik2zhz0.s[17];router.get('/auth/google',passport.authenticate('google',{scope:['email profile']}));// Callback from , but stuck here
++cov_212ik2zhz0.s[18];router.get('/auth/google/callback',passport.authenticate('google',{failureRedirect:'/login',session:false}),function(req,res){++cov_212ik2zhz0.f[2];++cov_212ik2zhz0.s[19];// Authenticated successfully
res.redirect("/index.html?access_token="+req.user.password);});// Bearer Strategy
++cov_212ik2zhz0.s[20];passport.use(new BearerStrategy(function(token,done){++cov_212ik2zhz0.f[3];++cov_212ik2zhz0.s[21];User.findOne({password:token},function(err,user){++cov_212ik2zhz0.f[4];++cov_212ik2zhz0.s[22];if(err){++cov_212ik2zhz0.b[0][0];++cov_212ik2zhz0.s[23];return done(err);}else{++cov_212ik2zhz0.b[0][1];}++cov_212ik2zhz0.s[24];if(!user){++cov_212ik2zhz0.b[1][0];++cov_212ik2zhz0.s[25];return done(null,false);}else{++cov_212ik2zhz0.b[1][1];}++cov_212ik2zhz0.s[26];return done(null,user,{scope:'all'});});}));/***
For test only
***/++cov_212ik2zhz0.s[27];router.get('/:username',passport.authenticate('bearer',{session:false}),function(req,res){++cov_212ik2zhz0.f[5];++cov_212ik2zhz0.s[28];res.json({user:req.user.apiRepr()});});/***
Get stock list
***/++cov_212ik2zhz0.s[29];router.get('/:username/stock',passport.authenticate('bearer',{session:false}),(req,res)=>{++cov_212ik2zhz0.f[6];++cov_212ik2zhz0.s[30];return User.findOne({username:req.user.username})//
.populate('portfolio.investedStocks.stockId.stock').exec(function(err,user){++cov_212ik2zhz0.f[7];++cov_212ik2zhz0.s[31];res.status(200).json(user);});});/***
Buy new stock
***/++cov_212ik2zhz0.s[32];router.post('/:username/stock',passport.authenticate('bearer',{session:false}),(req,res)=>{++cov_212ik2zhz0.f[8];++cov_212ik2zhz0.s[33];Stock.create({symbol:req.body.symbol,price:req.body.price,currentPrice:req.body.price,quantity:req.body.quantity}).then(stock=>{++cov_212ik2zhz0.f[9];++cov_212ik2zhz0.s[34];return User.findOneAndUpdate({username:req.user.username},{$push:{"portfolio.investedStocks":{'stockId.stock':stock._id,'stockId.quantity':req.body.quantity}}}).exec().then(user=>{++cov_212ik2zhz0.f[10];++cov_212ik2zhz0.s[35];res.status(201).json(user);}).catch(err=>{++cov_212ik2zhz0.f[11];++cov_212ik2zhz0.s[36];console.log(err);});}).catch(err=>{++cov_212ik2zhz0.f[12];++cov_212ik2zhz0.s[37];console.log(err);});});/***
Buy and Sell update
***/++cov_212ik2zhz0.s[38];router.put('/:username/stock/:symbol',passport.authenticate('bearer',{session:false}),(req,res)=>{++cov_212ik2zhz0.f[13];++cov_212ik2zhz0.s[39];if(req.params.symbol!==req.body.symbol){++cov_212ik2zhz0.b[2][0];++cov_212ik2zhz0.s[40];return res.status(400).send("Request field does not match");}else{++cov_212ik2zhz0.b[2][1];}++cov_212ik2zhz0.s[41];return User.findOne({username:req.user.username}).populate('portfolio.investedStocks.stockId.stock').exec((err,user)=>{++cov_212ik2zhz0.f[14];let stocks=(++cov_212ik2zhz0.s[42],user.portfolio.investedStocks);let selectedId;let updateStockId;++cov_212ik2zhz0.s[43];for(let i=0;i<stocks.length;i++){++cov_212ik2zhz0.s[44];if(stocks[i].stockId.stock.symbol===req.body.symbol){++cov_212ik2zhz0.b[3][0];++cov_212ik2zhz0.s[45];selectedId=stocks[i].id;++cov_212ik2zhz0.s[46];user.portfolio.investedStocks[i].stockId.quantity=req.body.quantity;++cov_212ik2zhz0.s[47];updateStockId=user.portfolio.investedStocks[i].stockId.stock["_id"];}else{++cov_212ik2zhz0.b[3][1];}}++cov_212ik2zhz0.s[48];user.save(err=>{++cov_212ik2zhz0.f[15];++cov_212ik2zhz0.s[49];if(err){++cov_212ik2zhz0.b[4][0];++cov_212ik2zhz0.s[50];console.log(err);}else{++cov_212ik2zhz0.b[4][1];}});++cov_212ik2zhz0.s[51];return Stock.findById(updateStockId).exec().then(stock=>{++cov_212ik2zhz0.f[16];++cov_212ik2zhz0.s[52];stock.currentPrice=req.body.price;++cov_212ik2zhz0.s[53];stock.save(err=>{++cov_212ik2zhz0.f[17];++cov_212ik2zhz0.s[54];if(err){++cov_212ik2zhz0.b[5][0];++cov_212ik2zhz0.s[55];console.log(err);}else{++cov_212ik2zhz0.b[5][1];}});++cov_212ik2zhz0.s[56];res.status(204).json(stock);}).catch(err=>{++cov_212ik2zhz0.f[18];++cov_212ik2zhz0.s[57];console.log("Update Stock Error: "+err);});}).catch(err=>{++cov_212ik2zhz0.f[19];++cov_212ik2zhz0.s[58];console.log(err);++cov_212ik2zhz0.s[59];res.status(500).json({error:'Error'});});});/***
Update current price for stock TODO
***/++cov_212ik2zhz0.s[60];router.put('/:username/stock/:symbol/:price',passport.authenticate('bearer',{session:false}),(req,res)=>{++cov_212ik2zhz0.f[20];++cov_212ik2zhz0.s[61];if((++cov_212ik2zhz0.b[7][0],req.params.price!==req.body.price)||(++cov_212ik2zhz0.b[7][1],req.params.symbol!==req.body.symbol)){++cov_212ik2zhz0.b[6][0];++cov_212ik2zhz0.s[62];return res.status(400).send("Request field does not match");}else{++cov_212ik2zhz0.b[6][1];}++cov_212ik2zhz0.s[63];return User.findOne({username:req.user.username}).populate('portfolio.investedStocks.stockId.stock').exec((err,user)=>{++cov_212ik2zhz0.f[21];let stocks=(++cov_212ik2zhz0.s[64],user.portfolio.investedStocks);let updateStockId;++cov_212ik2zhz0.s[65];for(let i=0;i<stocks.length;i++){++cov_212ik2zhz0.s[66];if(stocks[i].stockId.stock.symbol===req.body.symbol){++cov_212ik2zhz0.b[8][0];++cov_212ik2zhz0.s[67];updateStockId=user.portfolio.investedStocks[i].stockId.stock["_id"];}else{++cov_212ik2zhz0.b[8][1];}}++cov_212ik2zhz0.s[68];return Stock.findById(updateStockId).exec().then(stock=>{++cov_212ik2zhz0.f[22];++cov_212ik2zhz0.s[69];stock.currentPrice=req.body.price;++cov_212ik2zhz0.s[70];stock.save(err=>{++cov_212ik2zhz0.f[23];++cov_212ik2zhz0.s[71];if(err){++cov_212ik2zhz0.b[9][0];++cov_212ik2zhz0.s[72];console.log(err);}else{++cov_212ik2zhz0.b[9][1];}});++cov_212ik2zhz0.s[73];res.status(204).json(stock);}).catch(err=>{++cov_212ik2zhz0.f[24];++cov_212ik2zhz0.s[74];console.log("Update Stock Price Error: "+err);});}).catch(err=>{++cov_212ik2zhz0.f[25];++cov_212ik2zhz0.s[75];console.log(err);++cov_212ik2zhz0.s[76];res.status(500).json({error:'Error'});});});++cov_212ik2zhz0.s[77];module.exports={router};