var cov_clthgtty5=function(){var path='/Users/thomas/Desktop/sim-stock/userRouter.js',hash='3b155a4781a4414b7d5a57593eb1982bb4f74f5e',global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/Users/thomas/Desktop/sim-stock/userRouter.js',statementMap:{'0':{start:{line:1,column:24},end:{line:1,column:48}},'1':{start:{line:2,column:16},end:{line:2,column:34}},'2':{start:{line:3,column:17},end:{line:3,column:36}},'3':{start:{line:4,column:15},end:{line:4,column:32}},'4':{start:{line:5,column:15},end:{line:5,column:31}},'5':{start:{line:6,column:19},end:{line:6,column:48}},'6':{start:{line:7,column:17},end:{line:7,column:36}},'7':{start:{line:9,column:33},end:{line:9,column:52}},'8':{start:{line:11,column:0},end:{line:11,column:23}},'9':{start:{line:13,column:22},end:{line:35,column:2}},'10':{start:{line:15,column:1},end:{line:34,column:5}},'11':{start:{line:20,column:3},end:{line:20,column:16}},'12':{start:{line:21,column:3},end:{line:23,column:4}},'13':{start:{line:22,column:4},end:{line:22,column:60}},'14':{start:{line:24,column:3},end:{line:24,column:42}},'15':{start:{line:28,column:3},end:{line:32,column:4}},'16':{start:{line:29,column:4},end:{line:29,column:60}},'17':{start:{line:31,column:4},end:{line:31,column:28}},'18':{start:{line:37,column:0},end:{line:37,column:28}},'19':{start:{line:38,column:0},end:{line:38,column:34}},'20':{start:{line:41,column:0},end:{line:103,column:3}},'21':{start:{line:42,column:2},end:{line:44,column:3}},'22':{start:{line:43,column:4},end:{line:43,column:62}},'23':{start:{line:46,column:2},end:{line:48,column:3}},'24':{start:{line:47,column:4},end:{line:47,column:70}},'25':{start:{line:50,column:39},end:{line:50,column:47}},'26':{start:{line:52,column:2},end:{line:54,column:3}},'27':{start:{line:53,column:4},end:{line:53,column:77}},'28':{start:{line:56,column:2},end:{line:56,column:29}},'29':{start:{line:58,column:2},end:{line:60,column:3}},'30':{start:{line:59,column:4},end:{line:59,column:79}},'31':{start:{line:62,column:2},end:{line:64,column:3}},'32':{start:{line:63,column:4},end:{line:63,column:70}},'33':{start:{line:66,column:2},end:{line:68,column:3}},'34':{start:{line:67,column:4},end:{line:67,column:77}},'35':{start:{line:70,column:2},end:{line:70,column:29}},'36':{start:{line:72,column:2},end:{line:74,column:3}},'37':{start:{line:73,column:4},end:{line:73,column:79}},'38':{start:{line:76,column:2},end:{line:102,column:7}},'39':{start:{line:81,column:6},end:{line:83,column:7}},'40':{start:{line:82,column:8},end:{line:82,column:73}},'41':{start:{line:85,column:6},end:{line:85,column:40}},'42':{start:{line:88,column:5},end:{line:101,column:9}},'43':{start:{line:96,column:8},end:{line:96,column:52}},'44':{start:{line:99,column:7},end:{line:99,column:23}},'45':{start:{line:100,column:8},end:{line:100,column:64}},'46':{start:{line:112,column:0},end:{line:117,column:2}},'47':{start:{line:115,column:3},end:{line:115,column:40}},'48':{start:{line:120,column:0},end:{line:129,column:2}},'49':{start:{line:121,column:1},end:{line:128,column:5}},'50':{start:{line:127,column:3},end:{line:127,column:30}},'51':{start:{line:131,column:0},end:{line:159,column:2}},'52':{start:{line:132,column:1},end:{line:157,column:4}},'53':{start:{line:139,column:3},end:{line:156,column:6}},'54':{start:{line:152,column:5},end:{line:152,column:27}},'55':{start:{line:155,column:5},end:{line:155,column:22}},'56':{start:{line:161,column:0},end:{line:198,column:3}},'57':{start:{line:162,column:1},end:{line:164,column:2}},'58':{start:{line:163,column:2},end:{line:163,column:62}},'59':{start:{line:166,column:1},end:{line:197,column:4}},'60':{start:{line:172,column:15},end:{line:172,column:44}},'61':{start:{line:174,column:2},end:{line:174,column:34}},'62':{start:{line:175,column:2},end:{line:184,column:3}},'63':{start:{line:176,column:3},end:{line:176,column:29}},'64':{start:{line:177,column:3},end:{line:183,column:4}},'65':{start:{line:178,column:4},end:{line:178,column:30}},'66':{start:{line:181,column:4},end:{line:181,column:74}},'67':{start:{line:186,column:2},end:{line:190,column:4}},'68':{start:{line:187,column:3},end:{line:189,column:4}},'69':{start:{line:188,column:4},end:{line:188,column:20}},'70':{start:{line:192,column:2},end:{line:192,column:17}},'71':{start:{line:195,column:2},end:{line:195,column:19}},'72':{start:{line:196,column:2},end:{line:196,column:40}},'73':{start:{line:200,column:0},end:{line:207,column:2}},'74':{start:{line:201,column:2},end:{line:205,column:57}},'75':{start:{line:204,column:18},end:{line:204,column:39}},'76':{start:{line:205,column:17},end:{line:205,column:55}},'77':{start:{line:210,column:0},end:{line:210,column:24}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:13,column:40},end:{line:13,column:41}},loc:{start:{line:13,column:70},end:{line:35,column:1}},line:13},'1':{name:'(anonymous_1)',decl:{start:{line:18,column:8},end:{line:18,column:9}},loc:{start:{line:18,column:17},end:{line:26,column:3}},line:18},'2':{name:'(anonymous_2)',decl:{start:{line:27,column:8},end:{line:27,column:9}},loc:{start:{line:27,column:19},end:{line:34,column:3}},line:27},'3':{name:'(anonymous_3)',decl:{start:{line:41,column:17},end:{line:41,column:18}},loc:{start:{line:41,column:31},end:{line:103,column:1}},line:41},'4':{name:'(anonymous_4)',decl:{start:{line:80,column:10},end:{line:80,column:11}},loc:{start:{line:80,column:19},end:{line:86,column:5}},line:80},'5':{name:'(anonymous_5)',decl:{start:{line:87,column:10},end:{line:87,column:11}},loc:{start:{line:87,column:18},end:{line:102,column:5}},line:87},'6':{name:'(anonymous_6)',decl:{start:{line:95,column:10},end:{line:95,column:11}},loc:{start:{line:95,column:18},end:{line:97,column:7}},line:95},'7':{name:'(anonymous_7)',decl:{start:{line:98,column:13},end:{line:98,column:14}},loc:{start:{line:98,column:20},end:{line:101,column:7}},line:98},'8':{name:'(anonymous_8)',decl:{start:{line:114,column:2},end:{line:114,column:3}},loc:{start:{line:114,column:22},end:{line:116,column:3}},line:114},'9':{name:'(anonymous_9)',decl:{start:{line:120,column:81},end:{line:120,column:82}},loc:{start:{line:120,column:95},end:{line:129,column:1}},line:120},'10':{name:'(anonymous_10)',decl:{start:{line:124,column:8},end:{line:124,column:9}},loc:{start:{line:124,column:28},end:{line:128,column:3}},line:124},'11':{name:'(anonymous_11)',decl:{start:{line:131,column:82},end:{line:131,column:83}},loc:{start:{line:131,column:96},end:{line:158,column:2}},line:131},'12':{name:'(anonymous_12)',decl:{start:{line:138,column:8},end:{line:138,column:9}},loc:{start:{line:138,column:17},end:{line:157,column:3}},line:138},'13':{name:'(anonymous_13)',decl:{start:{line:150,column:10},end:{line:150,column:11}},loc:{start:{line:150,column:18},end:{line:153,column:5}},line:150},'14':{name:'(anonymous_14)',decl:{start:{line:154,column:11},end:{line:154,column:12}},loc:{start:{line:154,column:18},end:{line:156,column:5}},line:154},'15':{name:'(anonymous_15)',decl:{start:{line:161,column:89},end:{line:161,column:90}},loc:{start:{line:161,column:103},end:{line:198,column:1}},line:161},'16':{name:'(anonymous_16)',decl:{start:{line:169,column:7},end:{line:169,column:8}},loc:{start:{line:169,column:22},end:{line:193,column:2}},line:169},'17':{name:'(anonymous_17)',decl:{start:{line:186,column:12},end:{line:186,column:13}},loc:{start:{line:186,column:21},end:{line:190,column:3}},line:186},'18':{name:'(anonymous_18)',decl:{start:{line:194,column:8},end:{line:194,column:9}},loc:{start:{line:194,column:15},end:{line:197,column:2}},line:194},'19':{name:'(anonymous_19)',decl:{start:{line:200,column:93},end:{line:200,column:94}},loc:{start:{line:200,column:107},end:{line:206,column:2}},line:200},'20':{name:'(anonymous_20)',decl:{start:{line:204,column:9},end:{line:204,column:10}},loc:{start:{line:204,column:18},end:{line:204,column:39}},line:204},'21':{name:'(anonymous_21)',decl:{start:{line:205,column:10},end:{line:205,column:11}},loc:{start:{line:205,column:17},end:{line:205,column:55}},line:205}},branchMap:{'0':{loc:{start:{line:21,column:3},end:{line:23,column:4}},type:'if',locations:[{start:{line:21,column:3},end:{line:23,column:4}},{start:{line:21,column:3},end:{line:23,column:4}}],line:21},'1':{loc:{start:{line:28,column:3},end:{line:32,column:4}},type:'if',locations:[{start:{line:28,column:3},end:{line:32,column:4}},{start:{line:28,column:3},end:{line:32,column:4}}],line:28},'2':{loc:{start:{line:42,column:2},end:{line:44,column:3}},type:'if',locations:[{start:{line:42,column:2},end:{line:44,column:3}},{start:{line:42,column:2},end:{line:44,column:3}}],line:42},'3':{loc:{start:{line:46,column:2},end:{line:48,column:3}},type:'if',locations:[{start:{line:46,column:2},end:{line:48,column:3}},{start:{line:46,column:2},end:{line:48,column:3}}],line:46},'4':{loc:{start:{line:52,column:2},end:{line:54,column:3}},type:'if',locations:[{start:{line:52,column:2},end:{line:54,column:3}},{start:{line:52,column:2},end:{line:54,column:3}}],line:52},'5':{loc:{start:{line:58,column:2},end:{line:60,column:3}},type:'if',locations:[{start:{line:58,column:2},end:{line:60,column:3}},{start:{line:58,column:2},end:{line:60,column:3}}],line:58},'6':{loc:{start:{line:62,column:2},end:{line:64,column:3}},type:'if',locations:[{start:{line:62,column:2},end:{line:64,column:3}},{start:{line:62,column:2},end:{line:64,column:3}}],line:62},'7':{loc:{start:{line:66,column:2},end:{line:68,column:3}},type:'if',locations:[{start:{line:66,column:2},end:{line:68,column:3}},{start:{line:66,column:2},end:{line:68,column:3}}],line:66},'8':{loc:{start:{line:72,column:2},end:{line:74,column:3}},type:'if',locations:[{start:{line:72,column:2},end:{line:74,column:3}},{start:{line:72,column:2},end:{line:74,column:3}}],line:72},'9':{loc:{start:{line:81,column:6},end:{line:83,column:7}},type:'if',locations:[{start:{line:81,column:6},end:{line:83,column:7}},{start:{line:81,column:6},end:{line:83,column:7}}],line:81},'10':{loc:{start:{line:162,column:1},end:{line:164,column:2}},type:'if',locations:[{start:{line:162,column:1},end:{line:164,column:2}},{start:{line:162,column:1},end:{line:164,column:2}}],line:162},'11':{loc:{start:{line:177,column:3},end:{line:183,column:4}},type:'if',locations:[{start:{line:177,column:3},end:{line:183,column:4}},{start:{line:177,column:3},end:{line:183,column:4}}],line:177},'12':{loc:{start:{line:187,column:3},end:{line:189,column:4}},type:'if',locations:[{start:{line:187,column:3},end:{line:189,column:4}},{start:{line:187,column:3},end:{line:189,column:4}}],line:187}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0,'58':0,'59':0,'60':0,'61':0,'62':0,'63':0,'64':0,'65':0,'66':0,'67':0,'68':0,'69':0,'70':0,'71':0,'72':0,'73':0,'74':0,'75':0,'76':0,'77':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0],'9':[0,0],'10':[0,0],'11':[0,0],'12':[0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();const{BasicStrategy}=(++cov_clthgtty5.s[0],require('passport-http'));const express=(++cov_clthgtty5.s[1],require('express'));const mongoose=(++cov_clthgtty5.s[2],require('mongoose'));const morgan=(++cov_clthgtty5.s[3],require('morgan'));const router=(++cov_clthgtty5.s[4],express.Router());const jsonParser=(++cov_clthgtty5.s[5],require('body-parser').json());const passport=(++cov_clthgtty5.s[6],require('passport'));const{User,Portfolio,Stock}=(++cov_clthgtty5.s[7],require('./models'));++cov_clthgtty5.s[8];router.use(jsonParser);const basicStrategy=(++cov_clthgtty5.s[9],new BasicStrategy((username,password,done)=>{++cov_clthgtty5.f[0];let user;++cov_clthgtty5.s[10];User.findOne({username:username}).exec().then(_user=>{++cov_clthgtty5.f[1];++cov_clthgtty5.s[11];// console.log(password)
user=_user;++cov_clthgtty5.s[12];if(!user){++cov_clthgtty5.b[0][0];++cov_clthgtty5.s[13];return done(null,false,{message:'Invalid username'});}else{++cov_clthgtty5.b[0][1];}++cov_clthgtty5.s[14];return user.validatePassword(password);}).then(isValid=>{++cov_clthgtty5.f[2];++cov_clthgtty5.s[15];if(!isValid){++cov_clthgtty5.b[1][0];++cov_clthgtty5.s[16];return done(null,false,{message:'Invalid password'});}else{++cov_clthgtty5.b[1][1];++cov_clthgtty5.s[17];return done(null,user);}});}));++cov_clthgtty5.s[18];passport.use(basicStrategy);++cov_clthgtty5.s[19];router.use(passport.initialize());++cov_clthgtty5.s[20];router.post('/',(req,res)=>{++cov_clthgtty5.f[3];++cov_clthgtty5.s[21];if(!req.body){++cov_clthgtty5.b[2][0];++cov_clthgtty5.s[22];return res.status(400).json({message:'No request body'});}else{++cov_clthgtty5.b[2][1];}++cov_clthgtty5.s[23];if(!('username'in req.body)){++cov_clthgtty5.b[3][0];++cov_clthgtty5.s[24];return res.status(422).json({message:'Missing field: username'});}else{++cov_clthgtty5.b[3][1];}let{username,password,nickname}=(++cov_clthgtty5.s[25],req.body);++cov_clthgtty5.s[26];if(typeof username!=='string'){++cov_clthgtty5.b[4][0];++cov_clthgtty5.s[27];return res.status(422).json({message:'Incorrect field type: username'});}else{++cov_clthgtty5.b[4][1];}++cov_clthgtty5.s[28];username=username.trim();++cov_clthgtty5.s[29];if(username===''){++cov_clthgtty5.b[5][0];++cov_clthgtty5.s[30];return res.status(422).json({message:'Incorrect field length: username'});}else{++cov_clthgtty5.b[5][1];}++cov_clthgtty5.s[31];if(!password){++cov_clthgtty5.b[6][0];++cov_clthgtty5.s[32];return res.status(422).json({message:'Missing field: password'});}else{++cov_clthgtty5.b[6][1];}++cov_clthgtty5.s[33];if(typeof password!=='string'){++cov_clthgtty5.b[7][0];++cov_clthgtty5.s[34];return res.status(422).json({message:'Incorrect field type: password'});}else{++cov_clthgtty5.b[7][1];}++cov_clthgtty5.s[35];password=password.trim();++cov_clthgtty5.s[36];if(password===''){++cov_clthgtty5.b[8][0];++cov_clthgtty5.s[37];return res.status(422).json({message:'Incorrect field length: password'});}else{++cov_clthgtty5.b[8][1];}++cov_clthgtty5.s[38];return User.find({username}).count().exec().then(count=>{++cov_clthgtty5.f[4];++cov_clthgtty5.s[39];if(count>0){++cov_clthgtty5.b[9][0];++cov_clthgtty5.s[40];return res.status(422).json({message:'username already taken'});}else{++cov_clthgtty5.b[9][1];}++cov_clthgtty5.s[41];return User.hashPassword(password);}).then(hash=>{++cov_clthgtty5.f[5];++cov_clthgtty5.s[42];return User.create({username:username,password:hash,nickname:nickname,portfolio:req.body.portfolio}).then(user=>{++cov_clthgtty5.f[6];++cov_clthgtty5.s[43];return res.status(201).json(user.apiRepr());}).catch(err=>{++cov_clthgtty5.f[7];++cov_clthgtty5.s[44];console.log(err);++cov_clthgtty5.s[45];res.status(500).json({message:'Internal server error'});});});});/*
By default, if authentication fails, Passport will respond with a 401 Unauthorized status, 
and any additional route handlers will not be invoked. 
If authentication succeeds, the next handler will be invoked 
and the req.user property will be set to the authenticated user.
*/++cov_clthgtty5.s[46];router.get('/:username',passport.authenticate('basic',{session:false}),function(req,res){++cov_clthgtty5.f[8];++cov_clthgtty5.s[47];res.json({user:req.user.apiRepr()});// Question: Where is req.user came from? Ans: It is part of passport.js
});// Question: Stock is not bind to the account. Every user can manipulate the account
++cov_clthgtty5.s[48];router.get('/:username/stock',passport.authenticate('basic',{session:false}),(req,res)=>{++cov_clthgtty5.f[9];++cov_clthgtty5.s[49];return User.findOne({username:req.user.username})//
.populate('portfolio.investedStocks.stockId.stock').exec(function(err,user){++cov_clthgtty5.f[10];++cov_clthgtty5.s[50];//console.log(err);
//console.log(user.portfolio.investedStocks.stockId.stock);
res.status(200).json(user);});});++cov_clthgtty5.s[51];router.post('/:username/stock',passport.authenticate('basic',{session:false}),(req,res)=>{++cov_clthgtty5.f[11];++cov_clthgtty5.s[52];Stock.create({symbol:req.body.symbol,price:req.body.price,quantity:req.body.quantity}).then(stock=>{++cov_clthgtty5.f[12];++cov_clthgtty5.s[53];return User.findOneAndUpdate({username:req.user.username},{$push:{"portfolio.investedStocks":{// Use dot notation to push ! USe double quote!
'stockId.stock':stock._id,'stockId.quantity':req.body.quantity}}}).exec().then(user=>{++cov_clthgtty5.f[13];++cov_clthgtty5.s[54];//console.log(user);
res.status(204).end();}).catch(err=>{++cov_clthgtty5.f[14];++cov_clthgtty5.s[55];console.log(err);});});});++cov_clthgtty5.s[56];router.put('/:username/stock/:symbol',passport.authenticate('basic',{session:false}),(req,res)=>{++cov_clthgtty5.f[15];++cov_clthgtty5.s[57];if(req.params.symbol!==req.body.symbol){++cov_clthgtty5.b[10][0];++cov_clthgtty5.s[58];return res.status(400).send("Request field does not match");}else{++cov_clthgtty5.b[10][1];}++cov_clthgtty5.s[59];return User.findOne({username:req.user.username}).populate('portfolio.investedStocks.stockId.stock').exec((err,user)=>{++cov_clthgtty5.f[16];//console.log("Find User: " + user.portfolio.investedStocks);
//console.log(user.portfolio.investedStocks.stockId.stock)
let stocks=(++cov_clthgtty5.s[60],user.portfolio.investedStocks);let selectedId;++cov_clthgtty5.s[61];console.log("Stocks "+stocks);++cov_clthgtty5.s[62];for(let i=0;i<stocks.length;i++){++cov_clthgtty5.s[63];console.log(stocks[i]._id);++cov_clthgtty5.s[64];if(stocks[i].stockId.stock.symbol===req.body.symbol){++cov_clthgtty5.b[11][0];++cov_clthgtty5.s[65];selectedId=stocks[i].id;//user.portfolio.investedStocks[i].stockId
// update quantity
++cov_clthgtty5.s[66];user.portfolio.investedStocks[i].stockId.quantity=req.body.quantity;}else{++cov_clthgtty5.b[11][1];}}++cov_clthgtty5.s[67];user.save(err=>{++cov_clthgtty5.f[17];++cov_clthgtty5.s[68];if(err){++cov_clthgtty5.b[12][0];++cov_clthgtty5.s[69];console.log(err);}else{++cov_clthgtty5.b[12][1];}});++cov_clthgtty5.s[70];res.json(user);}).catch(err=>{++cov_clthgtty5.f[18];++cov_clthgtty5.s[71];console.log(err);++cov_clthgtty5.s[72];res.status(500).json({error:'Error'});});});++cov_clthgtty5.s[73];router.delete('/:username/stocks/:symbol',passport.authenticate('basic',{session:false}),(req,res)=>{++cov_clthgtty5.f[19];++cov_clthgtty5.s[74];Stock.findOneAndRemove({symbol:req.params.symbol}).exec().then(stock=>{++cov_clthgtty5.f[20];++cov_clthgtty5.s[75];return res.status(204).end();}).catch(err=>{++cov_clthgtty5.f[21];++cov_clthgtty5.s[76];return res.status(500).json({error:'Error'});});});++cov_clthgtty5.s[77];module.exports=router;